apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: chat-authz-policy
  namespace: default
spec:
  selector:
    matchLabels:
      app: chat-backend
  action: ALLOW
  rules:
    # Allow requests with valid JWT tokens
    - from:
        - source:
            requestPrincipals: ['https://oauth2.cat-herding.net/*']
    # Allow health, metrics, and docs endpoints without authentication
    - to:
        - operation:
            paths:
              [
                '/api/health',
                '/health',
                '/healthz',
                '/metrics',
                '/api/docs*',
                '/docs*',
              ]
    # Allow WebSocket connections for Socket.io
    # Socket.io needs both the initial HTTP upgrade request and the WebSocket frames
    - to:
        - operation:
            paths: ['/api/socket.io*', '/api/socket.io/*']
    # Allow static assets and frontend routes
    - to:
        - operation:
            paths: ['/', '/index.html', '/assets/*', '/static/*', '/_expo/*']
            methods: ['GET', 'HEAD', 'OPTIONS']

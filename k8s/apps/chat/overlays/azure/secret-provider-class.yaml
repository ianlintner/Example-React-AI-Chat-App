# Azure Key Vault SecretProviderClass
# This resource configures the CSI driver to mount secrets from Azure Key Vault
# Prerequisites:
# 1. Azure Key Vault created with secrets
# 2. AKS cluster with CSI driver addon enabled
# 3. Kubelet identity granted access to Key Vault
#
# Usage:
# 1. Replace  and  with your values (or use Kustomize)
# 2. Apply: kubectl apply -f secret-provider-class.yaml
# 3. Reference this in your deployment's volumeMount

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-keyvault-chat-secrets
  namespace: default
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"    # Use kubelet managed identity
    userAssignedIdentityID: "e502213f-1f15-4f03-9fb4-b546f51aafe9"  # Kubelet managed identity client ID
    keyvaultName: "ai-chat-kv-1763873634"  # Your Key Vault name
    cloudName: ""                    # [OPTIONAL] Use AzurePublicCloud (default), AzureChinaCloud, etc.
    objects: |
      array:
        - |
          objectName: OPENAI-API-KEY
          objectType: secret
          objectVersion: ""
    tenantId: "42ddc44e-97dd-4c3b-bf8a-31c785e24c67"  # Your Azure tenant ID
  secretObjects:
    # This creates a Kubernetes secret from the Key Vault secrets
    # so they can be used as environment variables
    - secretName: chat-secrets-from-keyvault
      type: Opaque
      data:
        - objectName: OPENAI-API-KEY
          key: OPENAI_API_KEY

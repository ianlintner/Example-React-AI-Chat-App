apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: chat-jwt-to-headers
  namespace: default
spec:
  workloadSelector:
    labels:
      app: chat-backend
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: 'envoy.filters.network.http_connection_manager'
              subFilter:
                name: 'envoy.filters.http.router'
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.lua
          typed_config:
            '@type': 'type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua'
            inlineCode: |
              function envoy_on_request(request_handle)
                -- Retrieve the metadata populated by the Istio JWT filter
                -- The key "envoy.filters.http.jwt_authn" contains the claims
                local meta = request_handle:streamInfo():dynamicMetadata():get("envoy.filters.http.jwt_authn")
                if meta then
                  -- The metadata is keyed by the issuer
                  local claims = meta["https://oauth2.cat-herding.net"]
                  if claims then
                    if claims["sub"] then request_handle:headers():add("x-auth-subject", claims["sub"]) end
                    if claims["iss"] then request_handle:headers():add("x-auth-issuer", claims["iss"]) end
                    if claims["email"] then request_handle:headers():add("x-auth-email", claims["email"]) end
                    if claims["name"] then request_handle:headers():add("x-auth-name", claims["name"]) end
                    if claims["picture"] then request_handle:headers():add("x-auth-picture", claims["picture"]) end
                    if claims["preferred_username"] then request_handle:headers():add("x-auth-username", claims["preferred_username"]) end
                    if claims["exp"] then request_handle:headers():add("x-auth-expires", claims["exp"]) end
                    if claims["iat"] then request_handle:headers():add("x-auth-issued-at", claims["iat"]) end
                    if claims["scope"] then request_handle:headers():add("x-auth-scope", claims["scope"]) end
                    if claims["scp"] then request_handle:headers():add("x-auth-scope", claims["scp"]) end
                    
                    -- Also pass the raw token if needed, but we are breaking it out
                    -- request_handle:headers():add("x-auth-token-valid", "true")
                  end
                end
              end
